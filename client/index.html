<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Brass Birmingham</title>
    <style>
        #game-board {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .city {
            border: 1px solid black;
            padding: 10px;
            text-align: center;
        }
        .city-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .slot {
            border: 1px solid #ccc;
            padding: 5px;
            min-width: 80px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .slot:hover {
            background-color: #f0f0f0;
        }
        .tile {
            background-color: #ddd;
            padding: 5px;
            margin: 2px 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .allowed-tiles {
            font-size: 0.8em;
            color: #666;
        }
        #tile-selection {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid black;
            padding: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>Simplified Brass Birmingham</h1>
    <div id="game-board"></div>
    <div id="player-info"></div>
    <div id="tile-selection">
        <h2>Select a Tile to Place</h2>
        <div id="tile-options"></div>
        <button id="cancel-tile-selection">Cancel</button>
    </div>
    <p id="connection-status">Connecting...</p>

    <script>
        class Game {
            constructor() {
                this.socket = new WebSocket('ws://localhost:9002');
                this.gameBoard = document.getElementById('game-board');
                this.playerInfo = document.getElementById('player-info');
                this.tileSelection = document.getElementById('tile-selection');
                this.tileOptions = document.getElementById('tile-options');
                this.cancelTileSelection = document.getElementById('cancel-tile-selection');
                this.connectionStatus = document.getElementById('connection-status');
                this.playerId = null;
                this.gameState = null;
                this.selectedCity = null;
                this.selectedSlot = null;

                this.initializeSocketListeners();
                this.initializeTileSelection();
            }

            initializeSocketListeners() {
                this.socket.onopen = () => {
                    console.log('Connected to server');
                    this.connectionStatus.textContent = 'Connected';
                };

                this.socket.onmessage = (event) => {
                    console.log('Received message:', event.data);
                    try {
                        this.gameState = JSON.parse(event.data);
                        this.updateGameBoard();
                        this.updatePlayerInfo();
                    } catch (error) {
                        console.error('Error parsing server message:', error);
                    }
                };

                this.socket.onclose = () => {
                    console.log('Disconnected from server');
                    this.connectionStatus.textContent = 'Disconnected. Please refresh the page.';
                };

                this.socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.connectionStatus.textContent = 'Connection error. Please refresh the page.';
                };
            }

            initializeTileSelection() {
                this.cancelTileSelection.onclick = () => {
                    this.tileSelection.style.display = 'none';
                };
            }

            sendPlaceTile(cityName, slotIndex, tileType) {
                if (this.socket.readyState === WebSocket.OPEN) {
                    const placeTileMessage = {
                        action: "placeTile",
                        cityName: cityName,
                        slotIndex: slotIndex,
                        tileType: tileType
                    };
                    this.socket.send(JSON.stringify(placeTileMessage));
                } else {
                    console.warn('Cannot send place tile: WebSocket is not open');
                }
            }

            updateGameBoard() {
                if (!this.gameState) return;
                this.gameBoard.innerHTML = '';

                for (const [cityName, cityData] of Object.entries(this.gameState.cities)) {
                    const cityElement = document.createElement('div');
                    cityElement.className = 'city';
                    cityElement.innerHTML = `
                        <h3>${cityName}</h3>
                        <p>Connections: ${cityData.connections.join(', ')}</p>
                        <div class="city-slots"></div>
                    `;
                    
                    const slotsContainer = cityElement.querySelector('.city-slots');
                    cityData.slots.forEach((slot, index) => {
                        const slotElement = document.createElement('div');
                        slotElement.className = 'slot';
                        if (slot.placedTile) {
                            slotElement.innerHTML = `<div class="tile">${slot.placedTile}</div>`;
                        } else {
                            slotElement.innerHTML = `
                                Slot ${index + 1}<br>
                                <span class="allowed-tiles">
                                    Allowed: ${slot.allowedTileTypes.join(', ')}
                                </span>
                            `;
                            slotElement.onclick = () => this.handleSlotClick(cityName, index, slot.allowedTileTypes);
                        }
                        slotsContainer.appendChild(slotElement);
                    });

                    this.gameBoard.appendChild(cityElement);
                }
            }

            handleSlotClick(cityName, slotIndex, allowedTileTypes) {
                this.selectedCity = cityName;
                this.selectedSlot = slotIndex;
                this.showTileSelection(allowedTileTypes);
            }

            showTileSelection(allowedTileTypes) {
                this.tileOptions.innerHTML = '';
                allowedTileTypes.forEach(tileType => {
                    const button = document.createElement('button');
                    button.textContent = tileType;
                    button.onclick = () => this.handleTileSelection(tileType);
                    this.tileOptions.appendChild(button);
                });
                this.tileSelection.style.display = 'block';
            }

            handleTileSelection(tileType) {
                this.sendPlaceTile(this.selectedCity, this.selectedSlot, tileType);
                this.tileSelection.style.display = 'none';
            }

            updatePlayerInfo() {
                if (!this.gameState) return;
                this.playerInfo.innerHTML = '';
                this.gameState.players.forEach(player => {
                    const playerElement = document.createElement('div');
                    playerElement.innerHTML = `
                        <h3>Player ${player.id}</h3>
                        <p>Score: ${player.score}</p>
                        <p>Money: ${player.money}</p>
                    `;
                    this.playerInfo.appendChild(playerElement);

                    if (this.playerId === null) {
                        this.playerId = player.id;
                    }
                });
            }
        }

        // Initialize the game when the page loads
        window.onload = () => {
            new Game();
        };
    </script>
</body>
</html>